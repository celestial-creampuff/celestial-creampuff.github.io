---
title: "[AWS] EC2에 Load Balancer 연동하기"
date: 2023-08-13 00:00:00 -0400
categories: AWS EC2 ELB Network
tags:
    - AWS
    - EC2
    - ELB
    - Application Load Balancer
toc: true
toc_sticky: true
---

## 개요

### ELB 이란?

**ELB(Elastic Load Balancer)**란 네트워크 트래픽을 분산하여 애플리케이션에 분배해주는 AWS 서비스입니다. 둘 이상의 가용 영역에서 로드 밸런서는 EC2, 컨테이너, IP주소 등 여러 대상에 걸쳐 수신되는 트래픽을 분산해주며 대상의 상태를 모니터링 하면서 Healch Check를 할 수 있습니다.

#### Load Balancer의 종류

Load Balancer는 기본적으로 아래와 같이 4가지의 종류로 사용되고 있습니다.
1. Classic Load Balancer

2. Application Load Balancer

3. Network Load Balancer

4. Gateway Load Balancer

## Hands-On

### 실습환경

- Chrome 브라우저 사용
- 로컬 = Mac 환경
- ap-northeast-2(서울 리전)

### EC2 인스턴스 2대 생성
1. 먼저 EC2 콘솔에서 인스턴스 2대를 생성합니다. (과정 생략)<br/>
저의 경우 기존에 만들어줬던 VPC가 있었으며, 해당 VPC에서 Public Subnet A와 C에 배치하였습니다!<br/>
<br/>
보안그룹 또한 ssh와 http의 0.0.0.0/0을 허용한 상태입니다.
![콘솔상에서 EC2](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%204.13.07.png)<br/>
[콘솔상에서 EC2](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%204.13.07.png)


### Target-Group 생성

#### Target Gruop이란?
Load Balancer를 먼저 만들기에 앞서 타겟그룹(대상그룹. TG. Target-Group)을 생성해야 합니다. Load Balance는 타겟 그룹을 보고 트래픽을 분산하기 때문입니다.<br/>
<br/>
따라서 Target Gruop 이란, 요청을 처리할 대상(서버)에 대한 집합이라고 이해하면 됩니다! 

#### Target-Group 생성하기
1. 먼저 EC2 콘솔에서 좌측 사이드바 부문에서 로드 밸런싱 -> 대상 그룹을 클릭합니다. 그리고 우측에 **대상 그룹 생성** 버튼을 클릭합니다.<br/>
<br/>
2. 아래 사진과 같이 대상 유형은 인스턴스를 선택하고 대상 그룹 이름을 설정합니다!<br/>
(저는 여기서 잘못 설정했습니다 ㅠㅠㅠ 웬만하면 대상그룹 생성 시 이름은 TG가 어울릴 것 같아요!)
<br/>
<br/>
그리고 저는 기존에 제가 만들었던 VPC를 선택하였습니다.<br/>
상태 검사의 프로토콜의 경우 http로 냅두고 다음을 클릭합니다!
<br/>
![대상 그룹 생성1](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.27.43.png)
[대상 그룹 생성1](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.27.43.png)
![대상 그룹 생성2](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.27.54.png)
[대상 그룹 생성2](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.27.54.png)<br/><br/>
3. 다음으로 넘어가셨다면 아래 화면과 같이 사용 가능한 인스턴스 목록이 뜹니다. 이제 여기서 대상들을 선택해주면 그 대상들은 타겟 그룹안에 들어가고 로드밸런서가 저 대상들에게 트래픽을 라우팅을 해줘요!<br/>
<br/>
타겟 그룹안에 넣고 싶은 인스턴스들을 체크하고 아래에 보류 중인 것으로 포함을 선택하면 하단 화면처럼 대상 보기와 같이 뜹니다. 그리고 대상 그룹 생성을 클릭합니다.
![대상 그룹 생성3](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.28.16.png)
[대상 그룹 생성3](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.28.16.png)
![대상 그룹 생성4](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.28.26.png)
[대상 그룹 생성4](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.28.26.png)
<br/>
그러면 아래와 같이 대상그룹이 생성된 것을 볼 수 있습니다.
![대상 그룹 생성5](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.28.35.png)
[대상 그룹 생성5](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.28.35.png)
<br/>

### Load Balancer 생성
이제 로드밸런서를 생성할 차례입니다!
저는 Application Load Balancer를 사용해주었습니다.

1. 로드 밸런서 생성을 클릭해주고 유형은 Application Load Balancer를 선택해줍니다.
![Load Balancer 생성 1](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.28.58.png)
[Load Balancer 생성 1](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.28.58.png)
![Load Balancer 생성 2](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.29.13.png)
[Load Balancer 생성 2](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.29.13.png)<br/>
<br/>

2. 테스트이기 때문에 로드밸런서를 인터넷 경계에 두었습니다. 그리고 해당 로드 밸런서에 이름을 만들어주고 VPC를 골라줍니다! <br/><br/>그리고 해당 가용영역과 서브넷을 선택해주세요.<br/><br/>
보안 그룹은 아래 사진과 같이 제가 만든 보안그룹을 ELB의 보안 그룹으로 하였습니다! 해당 보안그룹은 http 통신으로 0.0.0.0/0 트래픽이 오게끔 하였습니다.<br/><br/>
또한 리스너 및 라우팅에서는 대상그룹을 선택해야 합니다.
저는 해당 대상그룹을 조금 전에 만들었던 gosim-external-lb로 하였습니다!<br/>(원래 gosim-external-tg로 해야 하는데 오타났어요..)<br/><br/> 그리고 나머지 값은 그대로 두고 로드 밸런서 생성을 클릭해주세요.<br/>이 과정에서 pending 하는 데에 시간이 조금 걸리니 남은 시간동안 만들고만 말았던 EC2에서 홈페이지를 만들도록 합시다!
![Load Balancer 생성 3](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.29.33.png)
[Load Balancer 생성 3](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.29.33.png)
![Load Balancer 생성 4](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.30.01.png)
[Load Balancer 생성 4](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.30.01.png)
![Load Balancer 생성 5](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.30.24.png)
[Load Balancer 생성 5](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.30.24.png)
![Load Balancer 생성 6](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.30.35.png)
[Load Balancer 생성 6](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.30.35.png)

### EC2 연결 및 웹 페이지 만들기(Nginx)
먼저 저는 해당되는 EC2를 만들었을 때, 키 페어 없이 진행하였습니다. 그래서 따로 커맨드 툴을 이용하지 않고, AWS 콘솔에서 제공해주는 커맨드라인 툴을 이용해서 연결하였습니다.<br/><br/>
그리고 각 서버마다 아래와 같은 명령어를 입력해주면서 웹 페이지를 구축하였습니다! 아래를 잘 따라와주세요!
<br/>
```py
## 최고 관리자 권한 얻기
sudo su

## 패키지 업데이트
yum update

## nginx 설치
yum install nginx

## nginx 서비스를 시작
service nginx start

## nginx가 자동적으로 실행이 되도록 하기
systemctl enable nginx

## index.html이 있는 경로로 이동
cd /usr/share/nginx/html/

## index. html 편집
vim index.html 

### Server 1의 index.html
<!DOCTYPE html>
<html>
<head>
<title>gosim web page 01</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>gosim web page 01</h1>
<p>iPad, apple, iPhone </p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>

### Server 2의 index.html
<!DOCTYPE html>
<html>
<head>
<title>gosim web page 02</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>gosim web page 02</h1>
<p>Galaxy, Galaxy Tab, Samsung, Korea </p>
<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>

####
vim을 실행할 때는 i를 눌러 편집이 가능합니다.
그리고 편집을 다 했다면 ECS를 눌러 편집을 종료하고 키보드에 순서대로 : w q ! 를 입력하고 엔터를 눌러주세요(wq! => 강제 저장하고 종료)
그렇다면 vim 편집기를 종료할 수 있습니다!!
```

### EC2 웹 페이지 정상작동 확인 및 ALB 작동 확인
1. 위 과정을 다 거쳤다면 EC2 퍼블릭IP 주소를 검색 시 웹 페이지가 떠야 합니다. 먼저 EC2 인스턴스 목록에서 차례대로 EC2 Public Ip 주소를 입력해주세요.<br/><br/>
그리고 웹 주소에 붙여넣기를 합니다!<br/>(제대로 실행되었으면 3번째 사진 결과처럼 2번째 서버도 확인해주세요!)
![정상 작동 확인 1](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.38.58.png)
[정상 작동 확인 1](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.38.58.png)
![정상 작동 확인 2](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.48.18.png)
[정상 작동 확인 2](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.48.18.png)
![정상 작동 확인 3](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.48.23.png)
[정상 작동 확인 3](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.48.23.png)<br/><br/>

2. EC2 웹페이지는 잘 띄워지는 것을 볼 수 있었어요.<br/>
이제 다 완성된 Load Balancer에 가면 Load Balancer도 도메인 주소를 가지고 있는 것을 볼 수 있습니다.<br/>
<br/> 도메인 주소를 마찬가지로 웹 주소에 검색을 해주세요.<br/>
그리고 F5 or 새로고침 버튼을 누르면 트래픽의 부하 분산이 아래 2~3번째 사진과 골고루 이루어지는 것을 볼 수 있어요!
![정상 작동 확인 4](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.49.53.png)
[정상 작동 확인 4](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.49.53.png)
![정상 작동 확인 5](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.50.19.png)
[정상 작동 확인 5](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.50.19.png)
![정상 작동 확인 6](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.50.24.png)
[정상 작동 확인 6](/assets/2023-08-13-EC2-LB/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202023-08-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%202.50.24.png)

이렇게 EC2에 ALB를 연동하여 트래픽의 분산을 볼 수 있었습니다!

다음번에 하고 싶은 것이 있는데 이 Hands on과 연계되어 있어 그때까지 해당 리소스는 지우지 않을거예요!




## 출처 및 참고
[로드밸런서에 대한 설명](https://docs.aws.amazon.com/elasticloadbalancing/index.html)

[대상그룹](https://docs.aws.amazon.com/elasticloadbalancing/index.html)


